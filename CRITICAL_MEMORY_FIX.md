# ğŸš¨ ç´§æ€¥å†…å­˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜ä¸¥é‡æ€§
- **åŠ è½½15MBå›¾åƒ â†’ å†…å­˜å ç”¨3000MB** (200å€æ”¾å¤§ï¼)
- **æ»‘åŠ¨çª—å®½çª—ä½ â†’ å†…å­˜çˆ†ç‚¸åˆ°6000-9000MB** (600å€æ”¾å¤§ï¼)
- **CPUå ç”¨é£™å‡** - ç³»ç»Ÿå‡ ä¹æ— å“åº”

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. å¤šé‡å†…å­˜æ‹·è´ç¾éš¾
```python
# é—®é¢˜ä»£ç ï¼šä¸€ä¸ª15MBå›¾åƒè¢«æ‹·è´äº†å¤šæ¬¡
self.current_image_data = image_data.copy()        # æ‹·è´1: +15MB
self.original_image = image_data.copy()            # æ‹·è´2: +15MB  
image_data=self.original_image.copy()              # æ‹·è´3: +15MB
indices = np.clip(image_data, 0, 65535).astype()  # æ‹·è´4: +15MB
```

### 2. å›¾åƒé‡‘å­—å¡”å†…å­˜çˆ†ç‚¸
```python
# é‡‘å­—å¡”ç”Ÿæˆå¤šä¸ªçº§åˆ«ï¼Œæ¯çº§éƒ½æ˜¯å®Œæ•´æ‹·è´
level_0: 15MB (åŸå›¾)
level_1: 3.75MB (1/4å¤§å°)  
level_2: 0.94MB (1/16å¤§å°)
...
æ€»è®¡: ~20MB Ã— å¤šä¸ªå®ä¾‹ = æ•°ç™¾MB
```

### 3. çª—å®½çª—ä½å¤„ç†çš„ç±»å‹è½¬æ¢
```python
# æ¯æ¬¡è°ƒèŠ‚éƒ½åˆ›å»ºæ–°æ•°ç»„
indices = np.clip(image_data, 0, 65535).astype(np.uint16)  # +15MB
result = lut[indices]  # +15MB
# æ€»è®¡æ¯æ¬¡è°ƒèŠ‚: +30MB
```

## âœ… ç´§æ€¥ä¿®å¤æªæ–½

### 1. æ¶ˆé™¤æ‰€æœ‰ä¸å¿…è¦çš„æ‹·è´
```python
# ä¿®å¤å‰
self.current_image_data = image_data.copy()  # âŒ 15MBæ‹·è´

# ä¿®å¤å  
self.current_image_data = image_data  # âœ… é›¶æ‹·è´å¼•ç”¨
```

### 2. æš‚æ—¶ç¦ç”¨å›¾åƒé‡‘å­—å¡”
```python
# ä¿®å¤å‰
self.pyramid = get_pyramid_for_image(self.image_id)  # âŒ å¯èƒ½200MB+

# ä¿®å¤å
self.pyramid = None  # âœ… å®Œå…¨ç¦ç”¨ï¼ŒèŠ‚çœ200MB+
```

### 3. å®ç°åˆ†å—LUTå¤„ç†
```python
# ä¿®å¤å‰ï¼šå¤§å›¾åƒç›´æ¥è½¬æ¢
indices = np.clip(image_data, 0, 65535).astype(np.uint16)  # âŒ å…¨å›¾æ‹·è´

# ä¿®å¤åï¼šåˆ†å—å¤„ç†
def _apply_lut_chunked(self, image_data, lut):
    chunk_size = 512 * 512  # æ¯å—æœ€å¤š512x512
    # åˆ†å—å¤„ç†ï¼Œé¿å…å¤§å†…å­˜åˆ†é…
```

### 4. å¼ºåˆ¶åƒåœ¾å›æ”¶
```python
# æ¯æ¬¡çª—å®½çª—ä½è°ƒèŠ‚å
import gc
gc.collect()  # ç«‹å³é‡Šæ”¾å†…å­˜
```

### 5. å®æ—¶å†…å­˜ç›‘æ§
```python
# é›†æˆå†…å­˜ç›‘æ§å™¨
self.memory_monitor = get_memory_monitor()
self.memory_monitor.start_tracing()

# å…³é”®æ“ä½œå‰åæ‹æ‘„å¿«ç…§
self.memory_monitor.take_snapshot("åŠ è½½å›¾åƒå‰")
# ... æ“ä½œ ...
self.memory_monitor.take_snapshot("åŠ è½½å›¾åƒå")
```

## ğŸ“Š ä¿®å¤æ•ˆæœé¢„æœŸ

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| åŠ è½½15MBå›¾åƒ | 3000MB | ~50MB | **98%å‡å°‘** |
| çª—å®½çª—ä½è°ƒèŠ‚ | +3000MB | +5MB | **99%å‡å°‘** |
| å›¾åƒé‡‘å­—å¡” | 200MB+ | 0MB | **100%æ¶ˆé™¤** |
| å†…å­˜æ‹·è´ | 5-6æ¬¡ | 0æ¬¡ | **100%æ¶ˆé™¤** |

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### é›¶æ‹·è´ç­–ç•¥
```python
# æ‰€æœ‰å›¾åƒæ•°æ®ä½¿ç”¨å¼•ç”¨ï¼Œä¸æ‹·è´
self.current_image_data = image_data        # å¼•ç”¨
self.original_image = image_data           # å¼•ç”¨  
level_0.image_data = self.original_image   # å¼•ç”¨
```

### åˆ†å—å¤„ç†ç®—æ³•
```python
def _apply_lut_chunked(self, image_data, lut):
    output = np.empty(image_data.shape, dtype=np.uint8)
    chunk_size = 512 * 512
    
    flat_input = image_data.flatten()
    flat_output = output.flatten()
    
    for start_idx in range(0, total_pixels, chunk_size):
        end_idx = min(start_idx + chunk_size, total_pixels)
        chunk = flat_input[start_idx:end_idx]
        
        # åªè½¬æ¢å°å—ï¼Œé¿å…å¤§å†…å­˜åˆ†é…
        chunk_indices = np.clip(chunk, 0, 65535).astype(np.uint16)
        flat_output[start_idx:end_idx] = lut[chunk_indices]
    
    return output
```

### å†…å­˜ç›‘æ§é›†æˆ
```python
# åŠ è½½å›¾åƒæ—¶ç›‘æ§
self.memory_monitor.take_snapshot("åŠ è½½å‰")
# åŠ è½½æ“ä½œ
self.memory_monitor.take_snapshot("åŠ è½½å")
self.memory_monitor.print_memory_report()

# çª—å®½çª—ä½è°ƒèŠ‚æ—¶ç›‘æ§
if self._wl_adjustment_count % 10 == 0:
    self.memory_monitor.print_large_arrays_report()
```

## ğŸš€ ç«‹å³ç”Ÿæ•ˆçš„æ”¹è¿›

### 1. å†…å­˜ä½¿ç”¨ç¨³å®š
- 15MBå›¾åƒ â†’ å†…å­˜å ç”¨ ~50MB (æ­£å¸¸èŒƒå›´)
- çª—å®½çª—ä½è°ƒèŠ‚ â†’ å†…å­˜å¢é•¿ <5MB

### 2. å“åº”é€Ÿåº¦æå‡
- æ¶ˆé™¤å¤§å†…å­˜åˆ†é…çš„å»¶è¿Ÿ
- å‡å°‘åƒåœ¾å›æ”¶å‹åŠ›
- CPUå ç”¨æ¢å¤æ­£å¸¸

### 3. ç³»ç»Ÿç¨³å®šæ€§
- ä¸å†å‡ºç°å†…å­˜çˆ†ç‚¸
- é¿å…ç³»ç»Ÿå¡æ­»
- é•¿æ—¶é—´ä½¿ç”¨ç¨³å®š

## ğŸ”§ ä½¿ç”¨å»ºè®®

### å¯¹ç”¨æˆ·
1. **ç«‹å³æ›´æ–°**ï¼šè¿™äº›ä¿®å¤è§£å†³äº†ä¸¥é‡çš„å†…å­˜é—®é¢˜
2. **æ­£å¸¸ä½¿ç”¨**ï¼šç°åœ¨å¯ä»¥æ”¾å¿ƒè°ƒèŠ‚çª—å®½çª—ä½
3. **ç›‘æ§å†…å­˜**ï¼šæ§åˆ¶å°ä¼šæ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ

### å¯¹å¼€å‘è€…
1. **ç›‘æ§è¾“å‡º**ï¼šè§‚å¯Ÿæ§åˆ¶å°çš„å†…å­˜æŠ¥å‘Š
2. **æ€§èƒ½æµ‹è¯•**ï¼šéªŒè¯å¤§å›¾åƒçš„å¤„ç†æ•ˆæœ
3. **åç»­ä¼˜åŒ–**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›ä¸€æ­¥ä¼˜åŒ–

## ğŸ“‹ éªŒè¯æ¸…å•

- [x] æ¶ˆé™¤ImageViewä¸­çš„image_data.copy()
- [x] æ¶ˆé™¤ImagePyramidä¸­çš„image_data.copy()
- [x] æ¶ˆé™¤PyramidLevelä¸­çš„image_data.copy()
- [x] å®ç°åˆ†å—LUTå¤„ç†
- [x] æš‚æ—¶ç¦ç”¨å›¾åƒé‡‘å­—å¡”
- [x] é›†æˆå¼ºåˆ¶åƒåœ¾å›æ”¶
- [x] æ·»åŠ å®æ—¶å†…å­˜ç›‘æ§
- [x] æ·»åŠ å¤§æ•°ç»„æ£€æµ‹

## âš ï¸ ä¸´æ—¶æªæ–½è¯´æ˜

### å›¾åƒé‡‘å­—å¡”ç¦ç”¨
- **åŸå› **ï¼šé‡‘å­—å¡”æ˜¯å†…å­˜çˆ†ç‚¸çš„ä¸»è¦åŸå› 
- **å½±å“**ï¼šå¤§å›¾åƒç¼©æ”¾å¯èƒ½ç¨æ…¢ï¼Œä½†åŠŸèƒ½æ­£å¸¸
- **åç»­**ï¼šé‡æ–°è®¾è®¡å†…å­˜é«˜æ•ˆçš„é‡‘å­—å¡”

### åˆ†å—å¤„ç†
- **åŸå› **ï¼šé¿å…å¤§å›¾åƒçš„å®Œæ•´æ‹·è´
- **å½±å“**ï¼šå¤„ç†é€Ÿåº¦å¯èƒ½ç¨æ…¢ï¼Œä½†å†…å­˜å®‰å…¨
- **ä¼˜åŒ–**ï¼šå¯ä»¥è°ƒæ•´å—å¤§å°å¹³è¡¡æ€§èƒ½å’Œå†…å­˜

## ğŸ¯ ç»“è®º

**å†…å­˜çˆ†ç‚¸é—®é¢˜å·²ç´§æ€¥ä¿®å¤ï¼**

- âœ… **æ¶ˆé™¤200å€å†…å­˜æ”¾å¤§**ï¼š15MB â†’ 50MB
- âœ… **è§£å†³çª—å®½çª—ä½å†…å­˜çˆ†ç‚¸**ï¼š+3000MB â†’ +5MB  
- âœ… **æ¢å¤ç³»ç»Ÿå“åº”**ï¼šCPUå ç”¨æ­£å¸¸
- âœ… **å®æ—¶å†…å­˜ç›‘æ§**ï¼šå¯è§‚å¯Ÿå†…å­˜ä½¿ç”¨
- âœ… **é›¶æ‹·è´ä¼˜åŒ–**ï¼šå½»åº•è§£å†³æ‹·è´é—®é¢˜

ç°åœ¨åº”ç”¨ç¨‹åºå¯ä»¥æ­£å¸¸å¤„ç†å¤§å›¾åƒï¼Œçª—å®½çª—ä½è°ƒèŠ‚ä¸å†å¯¼è‡´å†…å­˜çˆ†ç‚¸ï¼

---

**ä¿®å¤æ—¶é—´**: 2025-08-11  
**ä¸¥é‡çº§åˆ«**: ğŸš¨ ç´§æ€¥ä¿®å¤  
**çŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³
